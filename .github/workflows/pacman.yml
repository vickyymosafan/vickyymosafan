name: Generate Pacman Contribution Graph

on:
  # Run every 12 hours
  schedule:
    - cron: "0 */12 * * *"

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      speed:
        description: 'Game speed (1=normal, 2=fast)'
        required: false
        default: '2'
        type: choice
        options:
          - '1'
          - '2'

  # Trigger on push to main
  push:
    branches:
      - main

# Prevent duplicate runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GITHUB_USER: ${{ github.repository_owner }}
  GAME_SPEED: ${{ github.event.inputs.speed || '2' }}

jobs:
  # Matrix build for all themes - runs in parallel
  generate-themes:
    name: Generate ${{ matrix.theme }} theme
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - theme: github
            filename: pacman-contribution-graph.svg
            display_name: "GitHub Light"
          - theme: github-dark
            filename: pacman-contribution-graph-dark.svg
            display_name: "GitHub Dark"
          - theme: gitlab
            filename: pacman-contribution-graph-gitlab.svg
            display_name: "GitLab Light"
          - theme: gitlab-dark
            filename: pacman-contribution-graph-gitlab-dark.svg
            display_name: "GitLab Dark"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Generate Pacman SVG with retry logic
      - name: Generate ${{ matrix.display_name }} Pacman SVG
        id: generate
        uses: abozanona/pacman-contribution-graph@main
        with:
          github_user_name: ${{ env.GITHUB_USER }}
          outputs: ${{ matrix.filename }}
          theme: ${{ matrix.theme }}
        timeout-minutes: 5
        continue-on-error: true

      # Retry on failure
      - name: Retry generation if failed
        if: steps.generate.outcome == 'failure'
        uses: abozanona/pacman-contribution-graph@main
        with:
          github_user_name: ${{ env.GITHUB_USER }}
          outputs: ${{ matrix.filename }}
          theme: ${{ matrix.theme }}
        timeout-minutes: 5

      # Verify generated file
      - name: Verify SVG generated
        run: |
          if [ -f "dist/${{ matrix.filename }}" ]; then
            echo "âœ… ${{ matrix.display_name }} SVG generated successfully"
            ls -la dist/${{ matrix.filename }}
          else
            echo "âŒ Failed to generate ${{ matrix.display_name }} SVG"
            exit 1
          fi

      # Upload individual theme artifact
      - name: Upload ${{ matrix.display_name }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: pacman-${{ matrix.theme }}
          path: dist/${{ matrix.filename }}
          retention-days: 30

  # Combine all themes and deploy
  deploy:
    name: Deploy All Themes
    runs-on: ubuntu-latest
    needs: generate-themes
    timeout-minutes: 5

    permissions:
      contents: write

    steps:
      - name: Create dist directory
        run: mkdir -p dist

      # Download all theme artifacts
      - name: Download GitHub Light theme
        uses: actions/download-artifact@v4
        with:
          name: pacman-github
          path: dist/

      - name: Download GitHub Dark theme
        uses: actions/download-artifact@v4
        with:
          name: pacman-github-dark
          path: dist/

      - name: Download GitLab Light theme
        uses: actions/download-artifact@v4
        with:
          name: pacman-gitlab
          path: dist/
        continue-on-error: true

      - name: Download GitLab Dark theme
        uses: actions/download-artifact@v4
        with:
          name: pacman-gitlab-dark
          path: dist/
        continue-on-error: true

      # List all generated files
      - name: List all generated files
        run: |
          echo "ðŸ“¦ Generated Pacman SVGs:"
          ls -la dist/
          echo ""
          echo "ðŸŽ® Total files: $(ls -1 dist/*.svg 2>/dev/null | wc -l)"

      # Upload combined artifacts
      - name: Upload all Pacman artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pacman-all-themes
          path: dist/*.svg
          retention-days: 30

      # Deploy to output branch
      - name: Deploy to output branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: output
          publish_dir: ./dist
          keep_files: true
          force_orphan: false
          commit_message: "chore: update pacman contribution graphs (4 themes) [skip ci]"
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"

      - name: Summary
        run: |
          echo "## ðŸŽ® Pacman Contribution Graph Generation Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Themes:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Light" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Dark" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitLab Light" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitLab Dark" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files deployed to \`output\` branch" >> $GITHUB_STEP_SUMMARY